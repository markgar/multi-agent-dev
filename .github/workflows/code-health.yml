name: Code Health Check

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger (always runs)

permissions:
  issues: write
  contents: read

jobs:
  code-health:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run code health check
        id: health
        run: |
          BASELINE_FLAG=""
          if [ -f .code-health-baseline.json ]; then
            BASELINE_FLAG="--baseline .code-health-baseline.json"
          fi
          python scripts/code_health_check.py \
            --src-dir src/agent \
            $BASELINE_FLAG \
            --format markdown > report.md 2>&1 || true
          # Check if violations were found (header says "N issues found" or "hard violation")
          if grep -q "issues found" report.md; then
            echo "has_violations=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_violations=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run code health check (JSON)
        if: steps.health.outputs.has_violations == 'true'
        run: |
          BASELINE_FLAG=""
          if [ -f .code-health-baseline.json ]; then
            BASELINE_FLAG="--baseline .code-health-baseline.json"
          fi
          python scripts/code_health_check.py \
            --src-dir src/agent \
            $BASELINE_FLAG \
            --format json > report.json 2>&1 || true

      - name: Create or update issue
        if: steps.health.outputs.has_violations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            const title = 'ðŸ” Code Health: Violations Found';
            const label = 'code-health';

            // Ensure the label exists
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
              });
            } catch {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: 'fbca04',
                description: 'Automated code health check findings',
              });
            }

            // Look for an existing open issue with this label
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: 'open',
              per_page: 1,
            });

            const body = report + '\n\n---\n*Last updated: ' + new Date().toISOString() + '*';

            if (existing.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing[0].number,
                body: body,
              });
              console.log(`Updated issue #${existing[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: [label],
              });
              console.log('Created new code health issue');
            }

      - name: Close issue if clean
        if: steps.health.outputs.has_violations == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const label = 'code-health';
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: 'open',
              per_page: 1,
            });
            if (existing.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing[0].number,
                state: 'closed',
                state_reason: 'completed',
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing[0].number,
                body: 'âœ… All code health violations resolved!',
              });
              console.log(`Closed issue #${existing[0].number}`);
            }
